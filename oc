- name: Extend partition, VG, LV, and filesystem by 100GB
  hosts: localhost
  become: yes
  tasks:
    - name: Ensure parted is installed
      package:
        name: parted
        state: present

    - name: Check if /dev/nvme0n1p2 exists
      command: lsblk -no NAME /dev/nvme0n1
      register: partition_check
      changed_when: false

    - name: Extend partition /dev/nvme0n1p2 by 100GB
      command: >
        echo -e "resizepart 2 yes" | parted --script /dev/nvme0n1
      when: "'nvme0n1p2' in partition_check.stdout"

    - name: Inform the kernel of the updated partition table
      command: partprobe /dev/nvme0n1

    - name: Resize the physical volume on /dev/nvme0n1p2
      command: pvresize /dev/nvme0n1p2

    - name: Extend Logical Volume rootvg-home by 100GB
      command: lvextend -L +100G /dev/mapper/rootvg-home

    - name: Resize the filesystem on rootvg-home (XFS)
      command: xfs_growfs /home
      when: "'xfs' in ansible_facts.filesystems"

    - name: Resize the filesystem on rootvg-home (ext4)
      command: resize2fs /dev/mapper/rootvg-home
      when: "'ext4' in ansible_facts.filesystems"
