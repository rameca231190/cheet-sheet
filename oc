- name: Setup LVM on /dev/sdb and Extend rootvg-home
  hosts: localhost
  become: yes
  tasks:

    - name: Check if /dev/sdb1 partition already exists
      command: lsblk -no NAME /dev/sdb
      register: partition_check
      changed_when: false

    - name: Create partition on /dev/sdb (if not already partitioned)
      command: >
        echo -e "n\np\n1\n\n+50G\nt\n8e\nw" | fdisk /dev/sdb
      when: "'sdb1' not in partition_check.stdout"
    
    - name: Ensure kernel recognizes the new partition
      command: partprobe /dev/sdb

    - name: Create LVM Physical Volume on /dev/sdb1
      command: pvcreate /dev/sdb1
      ignore_errors: yes

    - name: Extend Volume Group rootvg with /dev/sdb1
      command: vgextend rootvg /dev/sdb1
      ignore_errors: yes

    - name: Get Free PE in rootvg
      command: vgdisplay -c rootvg | awk -F ':' '{print $16}'
      register: free_pe
      changed_when: false

    - name: Extend Logical Volume rootvg-home
      command: lvextend -l +{{ free_pe.stdout }} /dev/mapper/rootvg-home
      when: free_pe.stdout | int > 0

    - name: Resize Filesystem (XFS)
      command: xfs_growfs /home
      when: free_pe.stdout | int > 0
