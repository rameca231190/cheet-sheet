---
- name: Extend LVM using remaining free space
  hosts: localhost
  become: yes
  tasks:

    - name: Get disk free space information
      shell: parted /dev/nvme0n1 print free | awk '/Free Space/ {print $2, $3}'
      register: free_space
      changed_when: false

    - name: Extract and sort start/end positions for new partition
      set_fact:
        free_space_list: "{{ free_space.stdout_lines | map('split') | list }}"
    
    - name: Get last available free space entry
      set_fact:
        start_position: "{{ free_space_list[-1][0] }}"
        end_position: "{{ free_space_list[-1][1] }}"

    - name: Validate start and end positions
      debug:
        msg: "Start: {{ start_position }}, End: {{ end_position }}"

    - name: Create a new primary partition using all remaining free space
      shell: "parted /dev/nvme0n1 mkpart primary {{ start_position }}MB {{ end_position }}MB"
      when: start_position | int < end_position | int

    - name: Get the newly created partition name
      shell: lsblk -nrpo NAME,TYPE | awk '$2=="part" && /nvme0n1/ {print $1}' | tail -1
      register: new_partition
      changed_when: false

    - name: Initialize the new partition as a Physical Volume (PV)
      shell: "pvcreate {{ new_partition.stdout }}"
      when: new_partition.stdout is defined

    - name: Extend Volume Group (VG) rootvg with the new partition
      shell: "vgextend rootvg {{ new_partition.stdout }}"
      when: new_partition.stdout is defined

    - name: Extend Logical Volume (LV) rootvg-home using all available space
      shell: "lvextend -l +100%FREE /dev/mapper/rootvg-home"
    
    - name: Resize the filesystem on rootvg-home
      shell: "xfs_growfs /home"
      when: "'xfs' in lookup('pipe', 'df -T /home | tail -1 | awk \"{print $2}\"')"

    - name: Resize the filesystem on rootvg-home (ext4)
      shell: "resize2fs /dev/mapper/rootvg-home"
      when: "'ext4' in lookup('pipe', 'df -T /home | tail -1 | awk \"{print $2}\"')"

    - name: Verify updated disk space
      command: df -h
      register: disk_usage
      changed_when: false

    - debug:
        msg: "{{ disk_usage.stdout_lines }}"
