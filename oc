#!/bin/bash

max_retries=3   # Number of retries
delay=5         # Delay in seconds between retries
tigerastatusfilename="tigerastatus_failure_log.txt"

# Clear the log file before appending
> $tigerastatusfilename

oc get tigerastatus > tigera_output.txt

cat tigera_output.txt | while read line
do
    component=$(echo $line | cut -d ' ' -f1)
    available=$(echo $line | cut -d ' ' -f2)
    echo "component is $component available is $available"
    
    retry_count=0
    while [ "$available" = "False" ] && [ $retry_count -lt $max_retries ]; do
        echo "Retrying for component $component... attempt $((retry_count + 1))"
        sleep $delay
        available=$(oc get tigerastatus $component -o jsonpath='{.status.conditions[-1:].available}')
        retry_count=$((retry_count + 1))
    done

    if [ "$available" = "False" ]; then
        reason=$(oc get tigerastatus $component -o jsonpath='{.status.conditions[-1:].reason}')
        type=$(oc get tigerastatus $component -o jsonpath='{.status.conditions[-1:].type}')
        transitionTime=$(oc get tigerastatus $component -o jsonpath='{.status.conditions[-1:].lastTransitionTime}')
        status=$(oc get tigerastatus $component -o jsonpath='{.status.conditions[-1:].status}')
        
        echo "Reason for $component failure is $reason and stage type is $type since $transitionTime" >> $tigerastatusfilename
    fi
done
