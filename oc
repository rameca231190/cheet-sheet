- name: Check if amazon-efs-utils is installed
  shell: "rpm -q amazon-efs-utils"
  register: efs_check
  ignore_errors: yes

- name: Install missing dependency (stunnel) for amazon-efs-utils
  yum:
    name: stunnel
    state: present
  when: efs_check.rc != 0

- name: Download EFS Utils from Nexus
  shell: |
    export http_proxy=http://proxy.discoverfinancial.com:8080
    export https_proxy=http://proxy.discoverfinancial.com:8080
    wget https://nexus2.discoverfinancial.com/repository/dfs_third_party/cloud-foundation/infra-distribution/efs-utils/amazon-efs-utils-2.1.0-1.el8.x86_64.rpm
  args:
    chdir: /tmp
  when: efs_check.rc != 0

- name: Install amazon-efs-utils
  shell: rpm -ivh /tmp/amazon-efs-utils-2.1.0-1.el8.x86_64.rpm
  when: efs_check.rc != 0
